"use strict";Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e=Object(this),n=e.length>>>0,l=arguments[1],a=void 0,s=0;s<n;s++)if(a=e[s],t.call(l,a,s,e))return a}),Array.prototype.findIndex||(Array.prototype.findIndex=function(t){if(null===this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e=Object(this),n=e.length>>>0,l=arguments[1],a=void 0,s=0;s<n;s++)if(a=e[s],t.call(l,a,s,e))return s;return-1});var tb=angular.module("tb",["templates","ngSanitize","ui.router","ui.bootstrap","angular-loading-bar","ngStorage","ngToast"]);tb.constant("CONF",{appName:"typeset_buddy",debug:!1,version:"0.1.2"}),tb.config(["cfpLoadingBarProvider","$localStorageProvider",function(t,e){t.includeSpinner=!1,e.setKeyPrefix("tb_")}]),tb.run(["CONF","$transitions","$state","$stateParams","$templateCache","$rootScope","$trace","$uiRouter","Utils","themeManager","$timeout",function(t,e,n,l,a,s,o,i,r,c,p){function u(t){var e;e=t?new CSEvent("com.adobe.PhotoshopPersistent","APPLICATION"):new CSEvent("com.adobe.PhotoshopUnPersistent","APPLICATION"),e.extensionId=s.extensionID,s.CSI.dispatchEvent(e)}s.$state=n,s.$stateParams=l,s.utils=r,s.CSI=new CSInterface,s.extensionID=s.CSI.getExtensionID(),c.init(),s.os=s.CSI.getOSInformation().toLowerCase().indexOf("mac")>=0?"Mac":"Windows",s.debug=t.debug,s.log=function(t,e){1==s.debug&&(s.logContent||(s.logContent=[]),angular.isDefined(e)?(s.logContent.push({label:t,value:e}),console.log(t,e)):(s.logContent.push({label:"log",value:t}),console.log(t)))},1==s.debug?(o.enable(1),u(!1)):u(!0),s.$watch("debug",function(t,e){t!=e&&(s.debug?(o.enable(1),u(!1)):(o.disable(1),u(!0)))})}]),tb.config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/script_view"),t.state("app",{url:"/",controller:"AppCtrl",templateUrl:"app.tpl.html"}),t.state("log_view",{url:"/log_view",parent:"app",views:{app:{controller:["$scope",function(t){t.clearLog=function(){t.$root.logContent=[]}}],templateUrl:"log_view.tpl.html"}}})}]),tb.controller("AppCtrl",["$scope","$localStorage","$uibModal","Utils",function(t,e,n,l){t.resetLocalStorage=function(){l.showConfirmDialog("Are you sure you reset the localstorage? Every style set will be deleted.").then(function(){e.$reset()},function(){})},t.routes=[],t.$state.get().forEach(function(e){angular.isDefined(e.nav)&&e.nav===!0&&t.routes.push({name:e.name,label:e.label,order:e.order})}),t.routes.sort(function(t,e){return t.order<e.order?-1:t.order>e.order?1:0})}]),tb.factory("themeManager",["$rootScope","Utils",function(t,e){var n=this;return n.updateThemeWithAppSkinInfo=function(t){var n=t.panelBackgroundColor.color,l=e.colorToHex(n),a="F0F0F0",s=n.red>=122;s?(a="000000",$("#theme").attr("href","css/topcoat-desktop-light.css"),$("body").removeClass("dark"),$("body").addClass("light")):($("#theme").attr("href","css/topcoat-desktop-dark.css"),$("body").removeClass("light"),$("body").addClass("dark")),$("body").css("background-color","#"+l),$("body").css("color","#"+a)},n.onAppThemeColorChanged=function(t){var e=JSON.parse(window.__adobe_cep__.getHostEnvironment()).appSkinInfo;n.updateThemeWithAppSkinInfo(e)},n.init=function(){n.updateThemeWithAppSkinInfo(t.CSI.hostEnvironment.appSkinInfo),t.CSI.addEventListener(CSInterface.THEME_COLOR_CHANGED_EVENT,n.onAppThemeColorChanged)},n}]),tb.factory("Utils",["$uibModal",function(t){var e=this;return e.isNumeric=function(t){return t="string"==typeof t?t.replace(",","."):t,!isNaN(parseFloat(t))&&isFinite(t)&&"[object array]"!==Object.prototype.toString.call(t).toLowerCase()},e.endsWith=function(t,e){return t.indexOf(e,t.length-e.length)!==-1},e.uid=function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)});return e},e.isDateString=function(t){var e=Date.parse(t);return isNaN(t)&&!isNaN(e)},e.isNumeric=function(t){return t="string"==typeof t?t.replace(",","."):t,!isNaN(parseFloat(t))&&isFinite(t)&&"[object array]"!==Object.prototype.toString.call(t).toLowerCase()},e.isEmpty=function(t){for(var e in t)return!1;return!0},e.simpleComparison=function(t,e){return JSON.stringify(t)===JSON.stringify(e)},e.browserLocale=function(){return navigator.language?navigator.language:navigator.browserLanguage},e.addTrailingSlash=function(t){return e.endsWith(t,"/")?t:t+"/"},e.removeTrailingSlash=function(t){return e.endsWith(t,"/")?t.substr(0,t.length-1):t},e.extractFileExtension=function(t,e){var n=t.lastIndexOf("."),l=e?0:1;return n>-1?t.substr(n+l).toLowerCase():null},e.extractFilename=function(t){var e=t.lastIndexOf("/");return e>-1?t.substr(e+1):null},e.colorToHex=function(t,e){function n(t,e){var n=isNaN(e)?t:t+e;return n<0?n=0:n>255&&(n=255),n=Math.floor(n),n=n.toString(16),1===n.length?"0"+n:n}var l="";return t&&(l=n(t.red,e)+n(t.green,e)+n(t.blue,e)),l},e.getValidFileSuffix=function(t){var e=new Array;return 0==t.length||-1!=t.indexOf(".*")?e[0]="*":(t=" "+t+" ",t=t.replace(/\*/g," "),t=t.replace(/,/g," "),t=t.replace(/;/g," "),t=t.replace(/\./g," "),e=t.match(/\s\b\w*\b\s/g),e.forEach(function(t,e,n){n[e]=t.replace(/\s/g,"")})),e},e.showConfirmDialog=function(e){var n=t.open({templateUrl:"confirm_dialog.tpl.html",backdrop:"static",backdropClass:"active",size:"xs",resolve:{message:function(){return e}},controller:["$scope","message",function(t,e){t.message=e,t.cancel=function(){t.$dismiss()},t.submit=function(){t.$close()}}]});return n.result},e}]),tb.config(["$stateProvider",function(t){t.state("script_view",{url:"script_view",parent:"app",nav:!0,label:"Script",order:1,views:{app:{controller:"ScriptViewCtrl",templateUrl:"script_view.tpl.html"}}})}]),tb.controller("ScriptViewCtrl",["$scope","ScriptService","StylesService","Utils","ngToast","$timeout",function(t,e,n,l,a,s){t.reset=function(){t.filename="",t.scriptContent="",t.pageContent="",t.pageNumbers=[],t.pageScript="",t.pageNotes="",t.rawBubbles="",t.bubbles=[],t.pageStyle="",t.panelSeparator=e.panelSeparator(),t.useLayerGroups=e.useLayerGroups(),t.styleSet=n.getStyleSet(),t.selectedStyleset=t.styleSet.id},t.browseScript=function(){var e=window.cep.fs.showOpenDialogEx(!1,!1,"Select script file","",l.getValidFileSuffix("*.txt"),void 0,!1);angular.isDefined(e.data[0])&&t.loadScript(e.data[0])},t.loadScript=function(n,s,o){var i=window.cep.fs.readFile(n);0===i.err?(e.lastOpenedScript(n),t.filename=l.extractFilename(n),t.scriptContent=i.data,t.pageNumbers=e.getPageNumbers(t.scriptContent),t.pageNumbers.length>0?(o||a.create({className:"info",content:t.pageNumbers.length+" page(s) found in file"}),null!=s&&(t.selectedPage=s)):(a.create({className:"info",content:"Did not find any page number in the script"}),e.lastOpenedScript(null),e.lastOpenedPage(null),t.reset())):(e.lastOpenedScript(null),e.lastOpenedPage(null),t.reset(),a.create({className:"danger",content:"Could not read the file"}))},t.setPanelSeparator=function(n){t.panelSeparator=e.panelSeparator(n)},t.setUseLayerGroups=function(n){t.useLayerGroups=e.useLayerGroups(n)},t.loadPage=function(n){if(angular.isDefined(n)&&null!=n&&!l.isEmpty(t.scriptContent))if(t.pageScript=e.loadPage(t.scriptContent,n),null!=t.pageScript){var s=e.getTextStyles(t.pageScript[1],"default_style")[0];if(t.pageStyle=t.styleSet.styles.findIndex(function(t){return t.keyword==s})===-1?{keyword:s,inStyleSet:!1}:{keyword:s,inStyleSet:!0},t.$root.log("pageStyle",t.pageStyle),t.pageNotes=e.getNotes(t.pageScript[1]),t.$root.log("pageNotes",t.pageNotes),t.rawBubbles=t.pageScript[2],t.bubbles=[],t.$root.log("rawBubbles",t.rawBubbles),e.pageContainsText(t.rawBubbles)){t.$root.log("contains text");var o=[],i=t.pageStyle.keyword;o=t.rawBubbles.split("\n"),t.$root.log("lines",o),o.forEach(function(n){var l=e.skipThisLine(n,e.panelSeparator());if(l===!1){var a={text:e.cleanLine(n),styles:[],doublePart:!1,notes:e.getNotes(n)},s=[];e.isDoubleBubblePart(n)?(s=e.getTextStyles(n,i),a.doublePart=!0,t.bubbles[t.bubbles.length-1].hasChild=!0):s=e.getTextStyles(n,t.pageStyle.keyword),i=s[0],a.styles=s.map(function(e){var n=t.styleSet.styles.findIndex(function(t){return t.keyword==e});return n===-1?{keyword:e,inStyleSet:!1}:{keyword:e,inStyleSet:!0}}),t.bubbles.push(a)}else null===l&&t.bubbles.push({panelSeparator:!0})})}e.lastOpenedPage(n),t.$root.log("bubbles",t.bubbles)}else a.create({className:"info",content:"Could not find page "+n+" in file"}),t.selectedPage=null,e.lastOpenedPage(null),t.bubbles=[];else t.bubbles=[]},t.incPageNumber=function(n){var l=n?1:-1;if(t.pageNumbers.length)if(angular.isDefined(t.selectedPage)){var a=t.pageNumbers.findIndex(function(e){return e==t.selectedPage});angular.isDefined(t.pageNumbers[a+l])&&(t.selectedPage=t.pageNumbers[a+l],e.lastOpenedPage(t.selectedPage))}else t.selectedPage=t.pageNumbers[0]},t.typeset=function(n,l){if(t.selectedForcedStyle&&(t.$root.log("force style",t.selectedForcedStyle),l={keyword:t.selectedForcedStyle,inStyleSet:!0}),l.inStyleSet){var s=t.styleSet.styles.find(function(t){return t.keyword==l.keyword});s||(s=t.styleSet.styles[0]),s.useLayerGroups=e.useLayerGroups();var o={text:n,style:s};t.$root.log("typesetObj",o),e.typeset(o).then(function(){},function(t){a.create({className:"danger",content:t})})}else a.create({className:"danger",content:'Style "'+l.keyword+'" not found in styleset'})},t.reset(),t.loadStyleSet=function(){t.styleSet=n.getStyleSet(t.selectedStyleset)},s(function(){e.lastOpenedScript()&&t.loadScript(e.lastOpenedScript(),e.lastOpenedPage(),!0)},300),t.$watch("selectedPage",function(e,n){angular.isDefined(e)&&t.loadPage(e)}),t.$watch("panelSeparator",function(e,n){angular.isDefined(e)&&t.loadPage(t.selectedPage)}),t.$watch("selectedStyleset",function(e,n){angular.isDefined(e)&&null!=e&&(t.loadStyleSet(e),t.loadPage(t.selectedPage))})}]),tb.directive("bubbleItem",[function(){return{restrict:"E",scope:{bubble:"=",typesetAction:"&"},replace:!0,templateUrl:"bubble_item.tpl.html",controller:["$scope","Utils","ScriptService","StylesService",function(t,e,n,l){t.linkBubble=function(){t.bubble.linked?t.bubble.linked=!1:t.bubble.linked=!0}}]}}]),tb.factory("ScriptService",["$rootScope","$localStorage","$q","StylesService","Utils",function(t,e,n,l,a){var s=this;return s.init=function(){t.log("$localStorage",e),s.emptyPage=["blank","empty","no_text"],s.doubleBubbleSplitter="//",angular.isDefined(e.panelSeparator)||s.panelSeparator("–"),angular.isDefined(e.useLayerGroups)||s.useLayerGroups(!0),angular.isDefined(e.lastOpenedScript)||(e.lastOpenedScript="")},s.lastOpenedScript=function(t){return angular.isDefined(t)&&(e.lastOpenedScript=t),e.lastOpenedScript},s.lastOpenedPage=function(t){return angular.isDefined(t)&&(e.lastOpenedPage=t),e.lastOpenedPage},s.lastDestinationFolder=function(t){return angular.isDefined(t)&&(e.lastDestinationFolder=t),e.lastDestinationFolder},s.panelSeparator=function(t){return angular.isDefined(t)&&(e.panelSeparator=t),e.panelSeparator},s.useLayerGroups=function(t){return angular.isDefined(t)&&(e.useLayerGroups=!!t),e.useLayerGroups},s.skipSfx=function(t){return angular.isDefined(t)&&(e.skipSfx=!!t),e.skipSfx},s.getPageNumbers=function(t){for(var e=[],n=/\b([\d-]{3,9})#/g,l=void 0;null!==(l=n.exec(t));)l.index===n.lastIndex&&n.lastIndex++,e.push(l[1]);return e},s.loadPage=function(e,n){var l=new RegExp("\\b"+n+"#\\ ?(.*)?\\n([\\s\\S]*?)($|END|[\\d-]{3,9}#)"),a=l.exec(e);return t.log("page Match",a),a?a:null},s.pageContainsText=function(t){if(!t)return!1;if(t=t.trim(),0===t.length)return!1;for(var e=0;e<s.emptyPage.length;e++)if(0==t.indexOf("["+s.emptyPage[e]+"]"))return!1;return!0},s.getTextStyles=function(t,e){if(!t)return e?[e]:null;var n=/\[(\w+)\]/g,l=n.exec(t);if(l&&l[1]){n.lastIndex=0;for(var a=[];null!==(l=n.exec(t));)l.index===n.lastIndex&&n.lastIndex++,a.push(l[1].toLowerCase());return a}return e?[e]:null},s.getNotes=function(t){if(!t)return null;var e=/\[{2}([^\[]+)\]{2}/g,n=e.exec(t);if(n&&n[1]){e.lastIndex=0;for(var l=[];null!==(n=e.exec(t));)n.index===e.lastIndex&&e.lastIndex++,l.push(n[1]);return l}return null},s.cleanLine=function(t){if(!t)return null;var e=/(\[[\s\w\d]*\]\ ?)*(\/{0,2})([^\[]*)/,n=e.exec(t);return n&&n[n.length-1]?n[n.length-1].trim():null},s.skipThisLine=function(t,e){return!t||(t=s.cleanLine(t),!t||0==t.length||t==s.panelSeparator()&&null)},s.isDoubleBubblePart=function(t){if(!t)return!1;t=t.trim();var e=/^\/{2}.*$/,n=e.test(t);return!!n},s.typeset=function(e){var l=n.defer();return t.$root.CSI.evalScript("typesetEX("+JSON.stringify(e)+")",function(e){"typesetted"===e?l.resolve():(t.log("Typeset Error",e),l.reject(e))}),l.promise},s.init(),s}]),tb.config(["$stateProvider",function(t){t.state("styles",{url:"styles",parent:"app",nav:!0,label:"Styles",order:0,views:{app:{controller:"StylesCtrl",templateUrl:"styles.tpl.html"}}})}]),tb.controller("StylesCtrl",["$scope","StylesService","ScriptService","ngToast","Utils","$uibModal",function(t,e,n,l,a,s){t.newStyleSet=function(){t.styleSet=e.getDummyStyleSet(),t.selectedStyleset=null},t.saveStyleSet=function(){try{e.saveStyleSet(t.styleSet),t.loadCurrentStyleSet(),l.create({className:"success",content:"Saved"})}catch(t){l.create({className:"danger",content:t})}},t.exportStyleSet=function(){if(angular.isDefined(t.selectedStyleset)){var n=e.getStyleSet(t.selectedStyleset);delete n.id;var s=window.cep.fs.showSaveDialogEx("Export styleset",void 0,a.getValidFileSuffix("*.json"),n.name+"_styleset.json",void 0,"Export",void 0);if(s.data){var o=window.cep.fs.writeFile(s.data,JSON.stringify(n,null,2));0!=o.err&&l.create({className:"danger",content:"Failed to write a file at the destination:"+s.data+", error code:"+o.err})}}},t.maybeAddStyleToSet=function(n){var l=t.styleSet.styles.findIndex(function(t){return t.keyword==n});l==-1&&t.styleSet.styles.push(e.getDummyStyle(n))},t.extendStyleSet=function(){var e=window.cep.fs.showOpenDialogEx(!1,!1,"Select script file","",a.getValidFileSuffix("*.txt"),void 0,!1);if(angular.isDefined(e.data[0])){var s=window.cep.fs.readFile(e.data[0]);if(0===s.err){var o=s.data,i=n.getPageNumbers(o),r=[];i.length>0?(i.forEach(function(t){var e=n.loadPage(o,t);if(null!=e){var l=[];if(l.push(n.getTextStyles(e[1],"default_style")[0]),n.pageContainsText(e[2])){var a=e[2].split("\n");a.forEach(function(t){var e=n.getTextStyles(t,"default_style");l=l.concat(e.filter(function(t){return l.indexOf(t)<0}))})}r=r.concat(l.filter(function(t){return r.indexOf(t)<0}))}}),r.forEach(function(e){t.maybeAddStyleToSet(e)}),l.create({className:"success",content:"Done"})):l.create({className:"info",content:"Did not find any page number in the script"})}else l.create({className:"danger",content:"Could not read the file"})}},t.importStyleSet=function(){var n=window.cep.fs.showOpenDialogEx(!1,!1,"Select styleset file","",a.getValidFileSuffix("*.json"),void 0,!1);if(angular.isDefined(n.data[0])){t.selectedStyleset=null;var s=window.cep.fs.readFile(n.data[0]);if(0===s.err)try{var o=angular.merge({},e.getDummyStyleSet(),JSON.parse(s.data));e.cleanAndCheckStyleSet(o),delete o.id,t.styleSet=angular.copy(o)}catch(n){t.styleSet=e.getDummyStyleSet(),l.create({className:"danger",content:"Import error: "+n})}else t.styleSet=e.getDummyStyleSet(),l.create({className:"danger",content:"Could not read the file"})}},t.exportConstants=function(){var t=window.cep.fs.showSaveDialogEx("Export fonts and constant values",void 0,a.getValidFileSuffix("*.json"),"tb_fonts_and_constants.json",void 0,"Export",void 0);t.data&&e.getAppFonts().then(function(n){var a={fonts:n,styleConstants:angular.copy(e.constants)},s=window.cep.fs.writeFile(t.data,JSON.stringify(a,null,2));0!=s.err&&l.create({className:"danger",content:"Failed to write a file at the destination:"+t.data+", error code:"+s.err})})},t.addStyle=function(){t.styleSet.styles.push(e.getDummyStyle())},t.deleteStyleSet=function(){angular.isDefined(t.styleSet.id)&&a.showConfirmDialog('Are you sure you want to delete the style set "'+t.styleSet.name+'"').then(function(){e.deleteStyleSet(t.styleSet.id)===!0&&(l.create({className:"success",content:"Deleted"}),t.selectedStyleset=0)},function(){})},t.duplicateStyle=function(e){var n=angular.copy(e);n.keyword="Copy of "+n.keyword,delete n.default;var l=t.styleSet.styles.indexOf(e);l>-1?t.styleSet.styles.splice(l+1,0,n):t.styleSet.styles.push(n)},t.duplicateStyleSet=function(){if(angular.isDefined(t.selectedStyleset)){var n=e.getStyleSet(t.selectedStyleset);delete n.id,n.name="Copy of "+n.name,t.styleSet=n,t.selectedStyleset=null}},t.removeStyle=function(e){a.showConfirmDialog("Remove style ?").then(function(){var n=t.styleSet.styles.indexOf(e);n>-1&&t.styleSet.styles.splice(n,1)},function(){})},t.applyStyle=function(t){e.applyStyle(t).then(function(){l.create({className:"success",content:"Done"})},function(t){l.create({className:"danger",content:t})})},t.loadStyleSet=function(){t.styleSet=e.getStyleSet(t.selectedStyleset)},t.loadCurrentStyleSet=function(){t.styleSet=e.getStyleSet(),t.selectedStyleset=t.styleSet.id},t.loadCurrentStyleSet(),t.$watch("selectedStyleset",function(e,n){angular.isDefined(e)&&null!=e&&t.loadStyleSet(e)})}]),tb.directive("antialiasSelector",["StylesService",function(t){return{restrict:"E",scope:{selectedValue:"="},replace:!0,template:'<select ng-options="choice.value as choice.label for choice in choices" ng-model="selectedValue"></select>',link:function(e,n,l){e.choices=t.constants.antialias,e.selectedValue||(e.selectedValue=t.dummyStyle.antialias)}}}]),tb.directive("capitalizationSelector",["StylesService",function(t){return{restrict:"E",scope:{selectedValue:"="},replace:!0,template:'<select ng-options="choice.value as choice.label for choice in choices" ng-model="selectedValue"></select>',link:function(e,n,l){e.choices=t.constants.capitalization,e.selectedValue||(e.selectedValue=t.dummyStyle.capitalization)}}}]),tb.directive("fontSelector",["StylesService",function(t){return{restrict:"E",scope:{selectedValue:"="},replace:!0,template:'<select ng-options="choice.value as choice.label for choice in choices | orderBy: \'label\'" ng-model="selectedValue"></select>',link:function(e,n,l){t.getAppFonts().then(function(n){e.choices=n,e.selectedValue||(e.selectedValue=t.fontFallBack)})}}}]),tb.directive("justificationSelector",["StylesService",function(t){return{restrict:"E",scope:{selectedValue:"="},replace:!0,template:'<select ng-options="choice.value as choice.label for choice in choices" ng-model="selectedValue"></select>',link:function(e,n,l){e.choices=t.constants.justification,e.selectedValue||(e.selectedValue=t.dummyStyle.justification)}}}]),tb.directive("kerningSelector",["StylesService",function(t){return{restrict:"E",scope:{selectedValue:"="},replace:!0,template:'<select ng-options="choice.value as choice.label for choice in choices" ng-model="selectedValue"></select>',link:function(e,n,l){e.choices=t.constants.kerning,e.selectedValue||(e.selectedValue=t.dummyStyle.kerning)}}}]),tb.directive("tbStylePreset",[function(){return{restrict:"E",scope:{preset:"=",removeAction:"&",duplicateAction:"&",applyAction:"&"},templateUrl:"style_preset.tpl.html",controller:["$scope","StylesService",function(t,e){}]}}]),tb.directive("tbStyleSelector",["StylesService",function(t){return{restrict:"E",scope:{styleset:"=",selectedValue:"="},replace:!0,template:'<select ng-options="choice as choice for choice in choices" ng-model="selectedValue"><option value="">-</option></select>',link:function(e,n,l){e.refreshStyleList=function(){e.choices=[];var n=t.getStyleSet(e.styleset);n.styles.forEach(function(t){e.choices.push(t.keyword)}),e.selectedValue||(e.selectedValue=null)},e.$watch("styleset",function(t,n){angular.isDefined(t)?e.refreshStyleList():e.choices=[]})}}}]),tb.directive("stylesetSelector",["StylesService",function(t){return{restrict:"E",scope:{selectedValue:"="},replace:!0,template:'<select ng-options="choice.id as choice.name for choice in choices" ng-model="selectedValue"></select>',link:function(e,n,l){e.choices=[],e.refreshStylesetList=function(){e.choices=t.getStyleSetList(),e.selectedValue||(e.selectedValue=e.choices[0].id)},e.$on("refresh-styleset-list",e.refreshStylesetList),e.refreshStylesetList()}}}]),tb.factory("StylesService",["$rootScope","$localStorage","$q","Utils","ngToast",function(t,e,n,l,a){var s=this;if(s.constants={antialias:[{value:"CRISP",label:"Crisp"},{value:"SHARP",label:"Sharp"},{value:"SMOOTH",label:"Smooth"},{value:"STRONG",label:"Strong"},{value:"NONE",label:"None"}],kerning:[{value:"METRICS",label:"Metrics"},{value:"OPTICAL",label:"Optical"}],capitalization:[{value:"ALLCAPS",label:"All caps"},{value:"NORMAL",label:"Normal"},{value:"SMALLCAPS",label:"Small caps"}],justification:[{value:"CENTER",label:"Center"},{value:"CENTERJUSTIFIED",label:"Center justified"},{value:"FULLYJUSTIFIED",label:"Fully justified"},{value:"LEFT",label:"Left"},{value:"LEFTJUSTIFIED",label:"Left justified"},{value:"RIGHT",label:"Right"},{value:"RIGHTJUSTIFIED",label:"Right justified"}]},s.appFonts=[],s.fontFallBack="ArialMT",s.dummyStyle={keyword:null,layerGroup:null,fontName:null,size:20,leading:0,tracking:0,vScale:100,hScale:100,capitalization:"NORMAL",justification:"CENTER",antialias:"SMOOTH",fauxBold:!1,fauxItalic:!1,hyphenate:!0,kerning:"METRICS"},s.dummyStyleSet={name:null,styles:[angular.copy(s.dummyStyle)]},s.getAppFonts=function(){var e=n.defer();return s.appFonts.length?e.resolve(angular.copy(s.appFonts)):t.CSI.evalScript("getAppFonts()",function(t){s.appFonts=JSON.parse(t),e.resolve(angular.copy(s.appFonts))}),e.promise},s.getDummyStyle=function(t){var e=angular.copy(s.dummyStyle);return angular.isDefined(t)&&!l.isEmpty(t)&&(e.keyword=t),e},s.getDummyStyleSet=function(){var t=angular.copy(s.dummyStyleSet);return t.styles[0].default=!0,t.styles[0].keyword="default_style",t},s.getStyleSetList=function(){return e.styleSets},s.cleanAndCheckStyleSet=function(t){if(!angular.isDefined(t.name)||!t.name||!t.name.trim())throw"Need a name";if(t.name.length>25)throw"Name must be less than 25 characters";var n=0;if(!t.styles)throw"No styles in set";for(var l=0;l<t.styles.length;l++){if(!t.styles[l].keyword)throw"Some style keywords are undefined";if(t.styles[l].keyword=t.styles[l].keyword.trim().toLowerCase(),angular.isDefined(t.styles[l].default)&&1==t.styles[l].default&&(++n,"default_style"!=t.styles[l].keyword))throw'Default style must be named "default_style"'}if(0===n)throw"Missing default style";if(n>1)throw"Only one default style allowed";t.styles.sort(function(t,e){return t.keyword<e.keyword?-1:t.keyword>e.keyword?1:0});for(var a=0;a<t.styles.length;a++)for(var o in s.dummyStyle)angular.isDefined(t.styles[a][o])&&null!==t.styles[a][o]||(t.styles[a][o]=s.dummyStyle[o]);for(var i=e.styleSets.findIndex(function(e){return e.id==t.id}),r=0;r<e.styleSets.length;r++)if(e.styleSets[r].name.trim().toLowerCase()==t.name.trim().toLowerCase()&&e.styleSets[r].id!=i)throw"A styleset with the same name already exists";for(var c=0;c<t.styles.length;c++)if(angular.isDefined(t.styles[c+1])&&t.styles[c].keyword==t.styles[c+1].keyword)throw"The styleset contains duplicate style keywords"},s.saveStyleSet=function(n){s.cleanAndCheckStyleSet(n);var l=e.styleSets.findIndex(function(t){return t.id==n.id});if(l>-1)e.styleSets[l]=angular.copy(n);else{var a=-1;e.styleSets.forEach(function(t){t.id>a&&(a=t.id)}),n.id=++a,e.styleSets.push(angular.copy(n))}e.lastOpenedStyleSet=n.id,t.$broadcast("refresh-styleset-list")},s.getStyleSet=function(t){var n=void 0;if(angular.isDefined(t)){var l=e.styleSets.findIndex(function(e){return e.id==t});l>-1&&(n=angular.copy(e.styleSets[l]))}else angular.isDefined(e.lastOpenedStyleSet)&&(n=s.getStyleSet(e.lastOpenedStyleSet));return n?(e.lastOpenedStyleSet=n.id,n):s.getDummyStyleSet()},s.deleteStyleSet=function(n){var l=e.styleSets.findIndex(function(t){return t.id==n});return 0===e.styleSets[l].id?(a.create({className:"danger",content:"Cannot delete default style set"}),!1):l>-1?(e.styleSets.splice(l,1),delete e.lastOpenedStyleSet,t.$broadcast("refresh-styleset-list"),!0):void 0},s.applyStyle=function(e){var l=n.defer();return t.$root.CSI.evalScript("applyStyleToSelectedLayers("+JSON.stringify(e)+")",function(e){"done"===e?l.resolve():(t.log("Apply style error",e),l.reject(e))}),l.promise},!e.styleSets){e.styleSets=[];var o=s.getDummyStyleSet();o.name="Default set",s.saveStyleSet(o)}return s}]),angular.module("templates",[]).run(["$templateCache",function(t){t.put("app.tpl.html",'<uib-tabset active="null" class="">\n\t<uib-tab index="one.name" heading="{{one.label}}" ui-sref="{{one.name}}" ui-sref-active="active" ng-repeat="one in routes"></uib-tab>\n\t<uib-tab index="9" heading="Log" ui-sref="log_view" ui-sref-active="active" ng-if="$root.debug"></uib-tab>\n\t<uib-tab index="10" heading="RESET" ng-click="resetLocalStorage()" ng-if="$root.debug"></uib-tab>\n\n\n</uib-tabset>\n\n<ui-view name="app" class="flex-col"></ui-view>'),t.put("confirm_dialog.tpl.html",'<div class="modal-header">\n\t<h3 class="modal-title" id="modal-title">Confirm</h3>\n</div>\n<div class="modal-body" id="modal-body">\n\t{{message}}\n</div>\n<div class="modal-footer">\n\t<button class="btn btn-primary" type="button" ng-click="submit()">OK</button>\n\t<button class="btn btn-warning" type="button" ng-click="cancel()">Cancel</button>\n</div>'),t.put("log_view.tpl.html",'<div class="no-shrink p header">\n\t<button class="topcoat-button" ng-click="clearLog()">\n\t\t<span class="glyphicon glyphicon-trash"></span>\n\t\tClear log\n\t</button>\n</div>\n<div class="list scrollable">\n\t<div class="no-shrink row pb" ng-repeat="entry in $root.logContent">\n\t\t<div class="col-md-2 col-xs-2">\n\t\t\t<label>{{entry.label}}</label>\n\t\t</div>\n\t\t<div class="col-md-10 col-xs-10">\n\t\t\t<pre>{{entry.value|json}}</pre>\n\t\t</div>\n\t</div>\n</div>\n'),t.put("bubble_item.tpl.html",'<div class="row bubble-item" ng-class="{\'double-bubble\': !!bubble.doublePart, \'panel-separator\': !!bubble.panelSeparator}">\n\t<div class="col-lg-2 col-md-3 col-xs-3 text-center" ng-if="!!!bubble.panelSeparator">\n\t\t<button class="topcoat-button" ng-repeat="style in bubble.styles track by $index" ng-click="typesetAction({text: bubble.text, style: style.keyword})">\n\t\t\t<span>{{style.keyword}}</span>\n\t\t\t<span class="glyphicon glyphicon-warning-sign" ng-if="!!!style.inStyleSet"></span>\n\t\t</button>\n\t</div>\n\t<div class="col-lg-10 col-md-9 col-xs-9">\n\t\t<div class="bubble-content">{{bubble.text}}</div>\n\t\t<div class="bubble-note" ng-repeat="note in bubble.notes">{{note}}</div>\n\t</div>\n</div>'),t.put("script_view.tpl.html",'<div class="row no-shrink">\n\t<div class="col-md-6 col-xs-6 flex-input">\n\t\t<div class="input-wrapper">\n\t\t\t<label class="">\n\t\t\t\t<span>Script</span>\n\t\t\t</label>\n\t\t\t<input type="text" class="topcoat-text-input" readonly="true" ng-model="filename" ng-click="browseScript()">\n\t\t</div>\n\t\t<!-- <button class="topcoat-button" ng-click="browseScript()">Browse...</button> -->\n\t</div>\n\t<div class="col-md-5 col-xs-5 flex-input">\n\t\t<div class="input-wrapper">\n\t\t\t<label class="">\n\t\t\t\t<span>Style Set</span>\n\t\t\t</label>\n\t\t\t<styleset-selector selected-value="selectedStyleset"></styleset-selector>\n\t\t</div>\n\n\t</div>\n\t<div class="col-md-1 col-xs-1 flex-input">\n\t\t<div class="btn-group" uib-dropdown is-open="status.isopen">\n\t\t\t<button class="topcoat-button" uib-dropdown-toggle>\n\t\t\t\t<span class="glyphicon glyphicon-cog"></span>\n\t\t\t</button>\n\t\t\t<ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu role="menu" aria-labelledby="single-button">\n\t\t\t\t<li class="dropdown-header">Panel separator</li>\n\t\t\t\t<li role="menuitem" ng-class="{\'active\': panelSeparator == \'–\'}" ng-click="setPanelSeparator(\'–\')"><span>Long dash –</span></li>\n\t\t\t\t<li role="menuitem" ng-class="{\'active\': panelSeparator == \'-\'}" ng-click="setPanelSeparator(\'-\')"><span>Single dash -</span></li>\n\t\t\t\t<li role="menuitem" ng-class="{\'active\': panelSeparator == \'--\'}" ng-click="setPanelSeparator(\'--\')"><span>Double dash --</span></li>\n\t\t\t\t<li role="menuitem" ng-class="{\'active\': panelSeparator == \'=\'}" ng-click="setPanelSeparator(\'=\')"><span>Equal sign =</span></li>\n\t\t\t\t<li class="dropdown-header">Use layer groups</li>\n\t\t\t\t<li role="menuitem" ng-class="{\'active\': useLayerGroups === true}" ng-click="setUseLayerGroups(true)"><span>Yes</span></li>\n\t\t\t\t<li role="menuitem" ng-class="{\'active\': useLayerGroups === false}" ng-click="setUseLayerGroups(false)" ><span>No</span></li>\n\t\t\t</ul>\n\t\t</div>\n\t</div>\n</div>\n<div class="no-shrink row pb header">\n\t<div class="col-lg-4 col-md-4 col-xs-4">\n\t\t<label>Page</label>\n\t\t<button class="topcoat-icon-button--quiet" ng-disabled="!!!pageNumbers.length">\n\t\t\t<span class="glyphicon glyphicon-minus" ng-click="incPageNumber(false)"></span>\n\t\t</button>\n\n\t\t\t<select ng-options="pageNumber as pageNumber for pageNumber in pageNumbers" ng-model="selectedPage">\n\t\t\t\t<option value="">-</option>\n\t\t\t</select>\n\n\t\t<button class="topcoat-icon-button--quiet" ng-disabled="!!!pageNumbers.length">\n\t\t\t<span class="glyphicon glyphicon-plus" ng-click="incPageNumber(true)"></span>\n\t\t</button>\n\t</div>\n\t<div class="col-lg-4 col-md-4 col-xs-4">\n\t\t<label ng-if="!!selectedPage && !!bubbles.length">\n\t\t\tPage style: {{pageStyle.keyword}} <span class="glyphicon glyphicon-warning-sign" ng-if="!!!pageStyle.inStyleSet"></span>\n\t\t</label>\n\t</div>\n\t<div class="col-lg-4 col-md-4 col-xs-4">\n\t\t<label>\n\t\t\tForce\n\t\t</label>\n\t\t<tb-style-selector styleset="selectedStyleset" selected-value="selectedForcedStyle"></tb-style-selector>\n\n\t\t<!-- <div class="input-flex">\n\t\t\t<label>\n\t\t\t\t<span>Multi mode</span>\n\t\t\t</label>\n\t\t\t<div>\n\t\t\t\t<label class="topcoat-switch">\n\t\t\t\t\t<input type="checkbox" ng-model="multiMode" ng-true-value="true" class="topcoat-switch__input">\n\t\t\t\t\t<div class="topcoat-switch__toggle"></div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t</div> -->\n\t</div>\n\n</div>\n<div class="page-note" ng-repeat="pageNote in pageNotes">\n\t{{pageNote}}\n</div>\n<div class="list scrollable">\n\t<div class="list-item" ng-if="!!selectedPage && !!!bubbles.length">Nothing to typeset on this page</div>\n\t<!-- <bubble-item class="list-item" ng-repeat="bubble in bubbles" bubble="bubble" typeset-action="typeset(text, style)"></bubble-item> -->\n\n\t<div class="list-item row bubble-item" ng-class="{\'double-bubble\': !!bubble.doublePart, \'panel-separator\': !!bubble.panelSeparator}" ng-repeat="bubble in bubbles">\n\t\t<div class="col-lg-2 col-md-3 col-xs-3 text-center" ng-if="!!!bubble.panelSeparator">\n\t\t\t<button class="topcoat-button" ng-repeat="style in bubble.styles track by $index" ng-click="typeset(bubble.text, style)" ng-if="!!!multiMode" uib-tooltip="Create it or use the force :D" tooltip-popup-delay="500" tooltip-placement="bottom" tooltip-enable="!!!style.inStyleSet">\n\t\t\t\t<span>{{style.keyword}}</span>\n\t\t\t\t<span class="glyphicon glyphicon-warning-sign" ng-if="!!!style.inStyleSet"></span>\n\t\t\t</button>\n\t\t\t<label class="topcoat-checkbox" ng-if="!!multiMode">\n\t\t\t  <input type="checkbox" ng-model="bubble.selected" ng-true-value="true">\n\t\t\t\t<div class="topcoat-checkbox__checkmark"></div>\n\t\t\t</label>\n\t\t</div>\n\t\t<div class="col-lg-10 col-md-9 col-xs-9">\n\t\t\t<div class="bubble-content">{{bubble.text}}</div>\n\t\t\t<div class="bubble-note" ng-repeat="note in bubble.notes">{{note}}</div>\n\t\t</div>\n\t</div>\n\n</div>'),t.put("style_preset.tpl.html",'<div class="row m0">\n\t<div class="col-md-4 col-xs-4">\n\t\t<label class="input-flex">\n\t\t\t<span>Keyword</span>\n\t\t\t<input type="text" class="topcoat-text-input" placeholder="Keyword" ng-model="preset.keyword" ng-disabled="preset.default" ng-pattern="/^[\\d\\w_]+$/i">\n\t\t</label>\n\t</div>\n\t<div class="col-md-6 col-xs-6">\n\t\t<label class="input-flex input-flex-larger">\n\t\t\t<span>Font</span>\n\t\t\t<font-selector selected-value="preset.fontName"></font-selector>\n\t\t</label>\n\t</div>\n\t<div class="col-md-2 col-xs-2 text-right">\n\t\t<button class="topcoat-button" ng-click="duplicateAction()">\n\t\t\t<span class="glyphicon glyphicon-duplicate"></span>\n\t\t</button>\n\t\t<button class="topcoat-button" ng-click="removeAction()" ng-if="!!!preset.default">\n\t\t\t<span class="glyphicon glyphicon-trash"></span>\n\t\t</button>\n\t</div>\n</div>\n\n<div class="row m0">\n\t<div class="col-md-4 col-xs-4">\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Size (px)</span>\n\t\t\t\t<input type="number" class="topcoat-text-input" min="1" max="1000" step="1" ng-model="preset.size" placeholder="1 to 1000 px">\n\t\t\t</label>\n\t\t</div>\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>VScale</span>\n\t\t\t\t<input type="number" class="topcoat-text-input" min="0" max="1000" step="1" ng-model="preset.vScale" placeholder="1 to 1000 %">\n\t\t\t</label>\n\t\t</div>\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>HScale</span>\n\t\t\t\t<input type="number" class="topcoat-text-input" min="0" max="1000" step="1" ng-model="preset.hScale" placeholder="1 to 1000 %">\n\t\t\t</label>\n\t\t</div>\n\t\t<div class="input-flex">\n\t\t\t<label>\n\t\t\t\t<span>Hyphenate</span>\n\t\t\t</label>\n\t\t\t<div>\n\t\t\t\t<label class="topcoat-switch">\n\t\t\t\t\t<input type="checkbox" ng-model="preset.hyphenate" ng-true-value="true" class="topcoat-switch__input">\n\t\t\t\t\t<div class="topcoat-switch__toggle"></div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div class="col-md-4 col-xs-4">\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Leading</span>\n\t\t\t\t<input type="number" class="topcoat-text-input" min="0" max="1000" step="1" ng-model="preset.leading" placeholder="0 to 1000">\n\t\t\t</label>\n\t\t</div>\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Tracking</span>\n\t\t\t\t<input type="number" class="topcoat-text-input" min="-1000" max="10000" step="1" ng-model="preset.tracking" placeholder="-1000 to 10000">\n\t\t\t</label>\n\t\t</div>\n\t\t<div class="input-flex">\n\t\t\t<label>\n\t\t\t\t<span>FauxBold</span>\n\t\t\t</label>\n\t\t\t<div>\n\t\t\t\t<label class="topcoat-switch">\n\t\t\t\t\t<input type="checkbox" ng-model="preset.fauxBold" ng-true-value="true" class="topcoat-switch__input">\n\t\t\t\t\t<div class="topcoat-switch__toggle"></div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="input-flex">\n\t\t\t<label>\n\t\t\t\t<span>FauxItalic</span>\n\t\t\t</label>\n\t\t\t<div>\n\t\t\t\t<label class="topcoat-switch">\n\t\t\t\t\t<input type="checkbox" ng-model="preset.fauxItalic" ng-true-value="true" class="topcoat-switch__input">\n\t\t\t\t\t<div class="topcoat-switch__toggle"></div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div class="col-md-4 col-xs-4">\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Antialias</span>\n\t\t\t\t<antialias-selector selected-value="preset.antialias"></antialias-selector>\n\t\t\t</label>\n\t\t</div>\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Capitalization</span>\n\t\t\t\t<capitalization-selector selected-value="preset.capitalization"></capitalization-selector>\n\t\t\t</label>\n\t\t</div>\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Justification</span>\n\t\t\t\t<justification-selector selected-value="preset.justification"></justification-selector>\n\t\t\t</label>\n\t\t</div>\n\t\t<div>\n\t\t\t<label class="input-flex">\n\t\t\t\t<span>Kerning</span>\n\t\t\t\t<kerning-selector selected-value="preset.kerning"></kerning-selector>\n\t\t\t</label>\n\t\t</div>\n\t</div>\n</div>\n<div class="row m0">\n\t<div class="col-md-4 col-xs-4">\n\t\t<label class="input-flex">\n\t\t\t<span>Layer group</span>\n\t\t\t<input type="text" class="topcoat-text-input" placeholder="Layer group" ng-model="preset.layerGroup" >\n\t\t</label>\n\t</div>\n\t<div class="col-md-8 col-xs-8 text-right">\n\t\t<button class="topcoat-button" ng-click="applyAction()">\n\t\t\t<span class="glyphicon glyphicon-screenshot"></span>\n\t\t\t<span>Apply style on selected layers</span>\n\t\t</button>\n\t</div>\n</div>'),
t.put("styles.tpl.html",'<div class="no-shrink p">\n\t<button class="topcoat-button" ng-click="newStyleSet()" uib-tooltip="New" tooltip-popup-delay="500" tooltip-placement="right-bottom">\n\t<span class="glyphicon glyphicon-plus"></span>\n\t\t<!-- New -->\n\t</button>\n\t<button class="topcoat-button" ng-click="importStyleSet()" uib-tooltip="Import" tooltip-popup-delay="500" tooltip-placement="bottom">\n\t\t<span class="glyphicon glyphicon-import"></span>\n\t\t<!-- Import -->\n\t</button>\n\t<button class="topcoat-button" ng-click="extendStyleSet()" uib-tooltip="Analyze a script and extend current set with styles found within it" tooltip-popup-delay="500" tooltip-placement="bottom-left">\n\t\t<span class="glyphicon glyphicon-indent-right"></span>\n\t\t<!-- Extend -->\n\t</button>\n\t<button class="topcoat-button" ng-click="saveStyleSet()" uib-tooltip="Save" tooltip-popup-delay="500" tooltip-placement="bottom">\n\t\t<span class="glyphicon glyphicon-floppy-disk"></span>\n\t\t<!-- Save -->\n\t</button>\n\t<button class="topcoat-button" ng-click="exportStyleSet()" ng-disabled="selectedStyleset == undefined" uib-tooltip="Export" tooltip-popup-delay="500" tooltip-placement="bottom">\n\t\t<span class="glyphicon glyphicon-export"></span>\n\t\t<!-- Export -->\n\t</button>\n\t<button class="topcoat-button" ng-click="duplicateStyleSet()" ng-disabled="selectedStyleset == undefined" uib-tooltip="Duplicate" tooltip-popup-delay="500" tooltip-placement="bottom">\n\t\t<span class="glyphicon glyphicon-duplicate"></span>\n\t\t<!-- Duplicate -->\n\t</button>\n\t<button class="topcoat-button" ng-click="deleteStyleSet()" ng-disabled="!!!selectedStyleset" uib-tooltip="Delete" tooltip-popup-delay="500" tooltip-placement="bottom">\n\t\t<span class="glyphicon glyphicon-trash"></span>\n\t\t<!-- Delete -->\n\t</button>\n\t<styleset-selector selected-value="selectedStyleset"></styleset-selector>\n\t<button class="topcoat-button pull-right" ng-click="exportConstants()" uib-tooltip="Export available fonts and constant values" tooltip-popup-delay="500" tooltip-placement="left-bottom">\n\t\t<span class="glyphicon glyphicon-save"></span>\n\t\t<span class="glyphicon glyphicon-book"></span>\n\t</button>\n</div>\n\n<div class="row no-shrink pb header">\n\t<div class="col-md-4 col-xs-4">\n\t\t<label>\n\t\t\tName\n\t\t\t<input type="text" class="topcoat-text-input" placeholder="Styleset name" ng-model="styleSet.name" ng-disabled="selectedStyleset === 0" ng-pattern="/[\\d\\w]{1,30}/">\n\t\t</label>\n\t</div>\n\t<div class="col-md-4 col-xs-4">\n\n\t</div>\n\t<div class="col-md-4 col-xs-4 text-right">\n\t\t<button class="topcoat-button" ng-click="addStyle()">Add Style</button>\n\t</div>\n</div>\n<div class="list scrollable padded">\n\t<div class="list-item" ng-repeat="style in styleSet.styles">\n\t\t<tb-style-preset preset="style" remove-action="removeStyle(style)" duplicate-action="duplicateStyle(style)" apply-action="applyStyle(style)" ng-class="{\'default-style\': style.default}"></tb-style-preset>\n\t</div>\n\n</div>\n\n<!--<pre style="max-width: 100%; max-height: 200px; overflow-y: auto; word-wrap: break-word;" class="no-shrink">\n{{styleSet|json}}\n</pre>-->')}]);